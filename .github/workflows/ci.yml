# .github/workflows/ci.yml
name: Build and Test

on:
  push:
    branches: [ main, master, develop, "feature/**" ]  # Runs on main release and feature branches
    tags: [ 'v*.*.*' ]  # Ensure CI runs for version tags too
  pull_request:
    branches: [ main, master, develop ]  # Also runs on PRs to main/master/develop
  workflow_dispatch:  # Allow manual triggering

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  DOTNET_VERSION: '10.0.x'
  JAVA_VERSION: '17'
  CURRENT_VERSION: '1.0.0'

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Detect project type
    - name: Detect project type
      id: detect
      run: |
        if [ -f package.json ]; then
          echo "project_type=node" >> $GITHUB_OUTPUT
        elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
          echo "project_type=python" >> $GITHUB_OUTPUT
        elif find . -name "*.csproj" -type f | grep -q .; then
          echo "project_type=dotnet" >> $GITHUB_OUTPUT
        elif [ -f pom.xml ] || [ -f build.gradle ]; then
          echo "project_type=java" >> $GITHUB_OUTPUT
          if [ -f pom.xml ]; then
            echo "java_cache=maven" >> $GITHUB_OUTPUT
          else
            echo "java_cache=gradle" >> $GITHUB_OUTPUT
          fi
        else
          echo "project_type=unknown" >> $GITHUB_OUTPUT
        fi

    # =============== Node.js ===============
    - name: Set up Node.js and cache npm
      if: steps.detect.outputs.project_type == 'node'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          **/package-lock.json
          **/yarn.lock
          **/pnpm-lock.yaml

    # =============== Python ===============
    - name: Set up Python and cache pip
      if: steps.detect.outputs.project_type == 'python'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: |
          **/requirements.txt
          **/pyproject.toml
          **/setup.py
          **/poetry.lock

    # =============== .NET ===============
    - name: Set up .NET
      if: steps.detect.outputs.project_type == 'dotnet'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # .NET projects benefit from caching the ~/.nuget/packages folder
    - name: Cache NuGet packages
      if: steps.detect.outputs.project_type == 'dotnet'
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/obj/project.assets.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    # Calculate build version for .NET
    - name: Calculate .NET version
      if: steps.detect.outputs.project_type == 'dotnet'
      id: dotnet-version
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        VERSION="${{ env.CURRENT_VERSION }}.$BUILD_NUMBER"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building with version: $VERSION"

    # =============== Java ===============
    - name: Set up Java and cache Maven/Gradle
      if: steps.detect.outputs.project_type == 'java'
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: ${{ steps.detect.outputs.java_cache }}

    # Note: setup-java@v4 auto-caches Maven/Gradle using hashFiles() internally when `cache:` is set.
    # So no extra cache step is needed for Java.

    # =============== Install Dependencies ===============
    - name: Install dependencies
      run: |
        case "${{ steps.detect.outputs.project_type }}" in
          node)
            npm ci
            ;;
          python)
            pip install -r requirements.txt 2>/dev/null || pip install -e .
            ;;
          dotnet)
            dotnet restore
            ;;
          java)
            if [ -f pom.xml ]; then
              mvn dependency:go-offline
            elif [ -f build.gradle ]; then
              ./gradlew dependencies || gradle dependencies
            fi
            ;;
          *)
            echo "Unknown project type â€” skipping install"
            exit 1
            ;;
        esac

    # =============== Build ===============
    - name: Build
      run: |
        case "${{ steps.detect.outputs.project_type }}" in
          node)
            npm run build --if-present
            ;;
          dotnet)
            VERSION="${{ steps.dotnet-version.outputs.version }}"
            dotnet build --no-restore \
              /p:Version=$VERSION \
              /p:AssemblyVersion=$VERSION \
              /p:FileVersion=$VERSION \
              /p:InformationalVersion=$VERSION
            ;;
          java)
            if [ -f pom.xml ]; then
              mvn compile
            elif [ -f build.gradle ]; then
              ./gradlew build -x test || gradle build -x test
            fi
            ;;
          python|*)
            echo "No explicit build step required"
            ;;
        esac

    # =============== Run Tests ===============
    - name: Run tests
      run: |
        case "${{ steps.detect.outputs.project_type }}" in
          node)
            npm test
            ;;
          python)
            python -m pytest 2>/dev/null || python -m unittest discover || echo "No tests found"
            ;;
          dotnet)
            dotnet test --no-build --verbosity normal --logger trx --collect:"XPlat Code Coverage" --results-directory ./TestResults
            ;;
          java)
            if [ -f pom.xml ]; then
              mvn test
            elif [ -f build.gradle ]; then
              ./gradlew test || gradle test
            fi
            ;;
          *)
            echo "No test command defined"
            exit 1
            ;;
        esac

    # =============== Upload Test Results ===============
    - name: Upload .NET test results
      if: always() && steps.detect.outputs.project_type == 'dotnet'
      uses: actions/upload-artifact@v4
      with:
        name: test-results-dotnet-${{ runner.os }}
        path: |
          ./TestResults/
          **/coverage.cobertura.xml
        retention-days: 30
        if-no-files-found: ignore